# DrawingSupport (A tool for generating images of **Receipts/Labels/Tickets**)

> This document is generated by the Tongyi Lingma  
> [简体中文](https://github.com/Yiwei099/DrawingSupport/blob/master/README.md)
> 

## Origin
- There are too many printer brands, and the development cost of constructing SDK instructions is high. Text mode printing also yields unsatisfactory results.  
- Printers have varying text language support; some overseas printers cannot print Chinese characters, and certain languages or symbols may not print correctly or appear garbled.  
- Using View + Screenshot to generate images wastes system resources, blocks the main thread, and complicates thread management.  
- Layout is very difficult and limited whether using View + Screenshot or SDK instructions.  

## Overview
> ① Automatically measure text width and wrap lines adaptively.  
> ② Customize maximum width (to fit different paper sizes: 58mm/80mm).  
> ③ Customize maximum height (to fit label paper: limit or no limit on label size).  
> ④ Customize font size.  
> ⑤ Customize horizontal/vertical alignment.  
> ⑥ Mixed text and image layout.  
> ⑦ Customize line spacing.  

## Getting Started
### 1. Add it in your root build.gradle at the end of repositories:
```
dependencyResolutionManagement {
  repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
  repositories {
    mavenCentral()
    maven { url 'https://jitpack.io' }
  }
}
```
### 2. Add the dependency:
```
implementation 'com.github.Yiwei099:DrawingSupport:$releaseVersion'
```

## Details
### 1. Image Configuration
#### a. BitmapOption - Image Configuration
```
BitmapOption( 
    maxWidth: Int = 576,// Canvas width 
    topIndentation: Float = 40f,// Top margin 
    startIndentation: Float = 20f,// Start margin 
    endIndentation: Float = 20f,// End margin 
    bottomBlankHeight: Int = 10,// Bottom blank space 
    antiAlias: Boolean = false,// Enable anti-aliasing: true - enabled, false - disabled 
    maxHeight: Int = 0,// Canvas height 
    gravity: Int = Constant.Companion.Gravity.TOP,// Content alignment: top/center/bottom, default top (only applicable when canvas height is fixed) 
    followEffectItem: Boolean = false,// Only applicable when canvas height is fixed: true - terminate drawing if remaining canvas height is insufficient 
    config: Bitmap.Config = Bitmap.Config.RGB_565,// Default RGB_565 
)
```


### 2. Elements
#### a. TextParam - Plain Text
```
// Text content 
val text = "DrawingSupport"
// Font size 
val fontSize = 26f 
// Text alignment (left/center/right) 
val align = Constant.Companion.Align.ALIGN_CENTER 
// Element maximum width 
val weight = 0.5
// Text style (bold/italic/normal) 
val typeface = Typeface.DEFAULT 
// Element vertical alignment (top/center/bottom) 
val gravity = Constant.Companion.Gravity.TOP 
// Element bottom margin 
val perLineSpace = 10 
// Paint style 
var style: Paint.Style? = Paint.Style.FILL, 
// Stroke width 
var strokeWidth: Float = 0f, 
// Flags 
var flags: Int = Paint.DEV_KERN_TEXT_FLAG or Paint.EMBEDDED_BITMAP_TEXT_FLAG

// Create element 
val textItem = TextParam(text, weight, align).apply{ 
    size = fontSize 
    typeface = typeface 
    gravity = gravity 
    perLineSpace = perLineSpace 
    ...
    }
```
#### b. LineParam - Solid Line
```
//Element maximum width
val weight = 1.0
//Element bottom margin
val perLineSpace = 30

//Create element 
val lineItem = LineParam(weight).apply{
    perLineSpace = perLineSpace
}
```
#### c. LineDashedParam - Dashed Line
```
// Element maximum width 
val weight = 1.0 
// Element bottom margin 
val perLineSpace = 30

// Create element 
val lineDashedItem = LineDashedParam(weight).apply{         
    perLineSpace = perLineSpace
}
```
#### d. GraphicsParam - Image
```
// Image data 
val bitmap = Bitmap 
// Image byte array 
val bitmapData = BitmapUtils.compressBitmapToByteArray(bitmap) 
// Image width 
val width = bitmap.width 
// Image height 
val height = bitmap.height

// Create element 
val graphicsItem = GraphicsParam(bitmapData, width, height).apply { 
    perLineSpace = 40
}
```
#### e. MultiElementParam - Mixed Layout
```
// A row can contain up to five elements, and param1.weight + param2.weight + ... <= 1.0 
val multiPairItem = MultiElementParam( 
    param1 = textItem, 
    param2 = textItem, 
    //.. 
)

// Mixed text and image layout 
val multiGraphicsItem = MultiElementParam( 
    param1 = textItem, 
    param2 = graphicsItem,
    //..
)
```

## Usage
### 1. Inherit from **BaseProvide** to convert **business data** into **drawing data**, and provide standard parameters **BitmapOption**
```
class ReceiptProvide: BaseProvide(BitmapOption()) {
    // Entry point for data conversion
    fun start(order: Order,goodsData: List<Goods>,bitmap: Bitmap):ByteArray{
        //...2. Call the drawing function after data conversion
    }
    
    //Internal conversion function
    private fun convertData(order: Order,goodsData: List<Goods>,bitmap: Bitmap):List<BaseParam>{
        val result = mutableListOf<BaseParam>()
        //...3.Specific conversion details
        return result
    }
}
```
### 2. Call the drawing function after data conversion
```
// Data conversion result 
val params = convertData(order, goodsData, bitmap) 
// Draw result data 
val byteArray = startDraw(params)
```
### 3. Specific Conversion Details (Partially)
```
private fun convertOrderHeader(order: Order) = mutableListOf<BaseParam>().apply {
    add(
        TextParam(
            text = "Tax Invoice",
            align = Constant.Companion.Align.ALIGN_CENTER,
        ).apply {
            size = 26f
            typeface = Typeface.DEFAULT_BOLD
        }
    )

    add(
        TextParam(
            text = order.shopName,
            align = Constant.Companion.Align.ALIGN_CENTER,
        ).apply {
            size = 26f
        }
    )

    add(
        TextParam(
            text = order.shopAddress,
            align = Constant.Companion.Align.ALIGN_CENTER,
        ).apply {
            size = 26f
            typeface = Typeface.DEFAULT_BOLD
        }
    )

    add(
        TextParam(
            text = order.shopContact,
            align = Constant.Companion.Align.ALIGN_CENTER,
        ).apply {
            size = 26f
            typeface = Typeface.DEFAULT_BOLD
        }
    )

    add(
        TextParam(
            text = "Order#:${order.tableNo}",
            align = Constant.Companion.Align.ALIGN_CENTER,
        ).apply {
            size = 26f
            typeface = Typeface.DEFAULT_BOLD
        }
    )

    add(
        MultiElementParam(
            param1 = TextParam(
                text = "Served by",
                weight = 0.5,
            ).apply {
                size = 26f
            },
            param2 = TextParam(
                text = order.cashierID,
                align = Constant.Companion.Align.ALIGN_END,
                weight = 0.5,
            ).apply {
                size = 26f
            }
        )
    )

    add(
        MultiElementParam(
            param1 = TextParam(
                text = "Order Date",
                weight = 0.3,
            ).apply {
                size = 26f
            },
            param2 = TextParam(
                text = order.orderTime,
                align = Constant.Companion.Align.ALIGN_END,
                weight = 0.7,
            ).apply {
                size = 26f
            }
        )
    )

    add(
        MultiElementParam(
            param1 = TextParam(
                text = "Transaction#",
                weight = 0.4,
            ).apply {
                size = 26f
                gravity = Constant.Companion.Gravity.CENTER
            },
            param2 = TextParam(
                text = order.orderNo,
                align = Constant.Companion.Align.ALIGN_END,
                weight = 0.6,
            ).apply {
                perLineSpace = 10
                size = 26f
            }
        )
    )

    add(LineDashedParam().apply {
        perLineSpace = 30
    })

    add(
        MultiElementParam(
            param1 = TextParam(
                text = "Name",
                weight = 0.5,
            ).apply {
                size = 26f
            },
            param2 = TextParam(
                text = "AMT",
                align = Constant.Companion.Align.ALIGN_END,
                weight = 0.5,
            ).apply {
                size = 26f
            }
        ).apply {
            perLineSpace = 0
        }
    )

    add(LineDashedParam().apply {
        perLineSpace = 30
    })
}
```

### 4. Get the Drawn Result Data
```
val bitmapArray = receiptProvide.start(Order, GoodsList, bitmapCode)
```
### 5. Use the Drawn Result
#### a. Display on UI
```
val bitmap = BitmapUtils.byteDataToBitmap(bitmapArray)
imageView.setImageBitmap(bitmap)
```
#### b. Print ([100% Compatible Printing Tool: PrintSupport](https://github.com/Yiwei099/PrintSupport))
```
//Create a local network printer
val key = "192.168.100.150"
val printer = EscNetGPrinter(context, netKey) //Print Esc

//Create a graphic printing task
val mission = GraphicMission(bitmapArray)

//Call addMission to initiate printing
printer.addMission(mission)

//For more printer usage, please refer to PrintSupport
```
#### d. Storage
```
//... Storage logic
```
#### c. After generating Bitmap, destroy it if necessary
```
bitmap.recycle()
```


## Effect Preview
> For detailed usage, please refer to **MainActivity.kt**  
![Image Text](https://github.com/Yiwei099/DrawingSupport/blob/master/app/src/main/res/mipmap-hdpi/receipt.png)

## Contact Me
![Image Text](https://github.com/Yiwei099/DrawingSupport/blob/master/app/src/main/res/drawable/we_chat.jpg)

## Drawing Support by receipt (Updated irregularly)
